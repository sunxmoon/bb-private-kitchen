{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Current Order Header -->
    <div class="flex justify-between items-center px-1">
        <h2 class="text-xl font-bold text-gray-800">å½“å‰ç‚¹å•</h2>
        <div class="flex items-center space-x-3">
            <span class="text-xs font-medium text-gray-400 bg-gray-100 px-2 py-1 rounded-md">ID: #{{ current_order.id if current_order else 'None' }}</span>
            {% if current_order %}
            <button onclick="if(confirm('ç¡®å®šè¦æ¸…ç©ºå¹¶åˆ é™¤æ•´ä¸ªç‚¹å•å—ï¼Ÿ')) { document.getElementById('delete-order-form').submit(); }"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all shadow-sm">
                <i class="fas fa-trash-alt text-sm"></i>
            </button>
            <form id="delete-order-form" action="/delete-order/{{ current_order.id }}" method="POST" class="hidden"></form>
            {% endif %}
        </div>
    </div>

    {% if current_order and current_order.items %}
        <div class="space-y-4">
            {% for item in current_order.items %}
            <!-- Order Item Card -->
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden transition-all active:scale-[0.98]">
                <!-- Card Main Content -->
                <div class="p-3 flex items-start space-x-3 relative cursor-pointer" onclick="toggleDetails('details-{{ item.id }}')">
                    <!-- Image -->
                    <div class="relative">
                        {% if item.dish.image_url %}
                        <img src="{{ item.dish.image_url }}" class="w-20 h-20 rounded-2xl object-cover shadow-sm">
                        {% else %}
                        <div class="w-20 h-20 rounded-2xl bg-orange-50 flex items-center justify-center text-orange-300">
                            <i class="fas fa-utensils text-2xl"></i>
                        </div>
                        {% endif %}
                        <!-- Status Badge -->
                        <div class="absolute -top-1 -left-1">
                            {% if item.status == 'completed' %}
                            <span class="flex h-5 w-5 items-center justify-center rounded-full bg-green-500 text-[10px] text-white ring-2 ring-white">
                                <i class="fas fa-check"></i>
                            </span>
                            {% elif item.status == 'delayed' %}
                            <span class="flex h-5 w-5 items-center justify-center rounded-full bg-blue-500 text-[10px] text-white ring-2 ring-white">
                                <i class="fas fa-clock"></i>
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0 pr-16">
                        <div class="flex items-center space-x-2 mb-0.5">
                            <h3 class="font-bold text-gray-800 truncate">{{ item.dish.name }}</h3>
                            <span class="text-[10px] bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded-md font-bold whitespace-nowrap">{{ item.user.name }}</span>
                        </div>
                        
                        <div class="flex items-center text-orange-500 text-[11px] font-bold mb-1">
                            <i class="far fa-clock mr-1"></i>
                            <span>{{ item.preferred_time or 'å°½å¿«' }}</span>
                        </div>

                        <!-- Secondary Info (Small Text) -->
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[10px] text-gray-400">
                            <p class="truncate"><span class="text-orange-300 mr-1">â—</span>å£å‘³: {{ item.taste or '-' }}</p>
                            <p class="truncate"><span class="text-orange-300 mr-1">â—</span>åœ°ç‚¹: {{ item.location or '-' }}</p>
                            <p class="col-span-2 truncate"><span class="text-orange-300 mr-1">â—</span>å¤‡æ³¨: {{ item.remarks or 'æ— ' }}</p>
                        </div>
                    </div>

                    <!-- Quick Actions (Right Side) -->
                    <div class="absolute right-3 top-3 bottom-3 flex flex-col justify-between py-1" onclick="event.stopPropagation()">
                        <button onclick="submitAction('/complete-item/{{ item.id }}')" class="w-7 h-7 flex items-center justify-center rounded-lg bg-green-50 text-green-500 hover:bg-green-500 hover:text-white transition-colors">
                            <i class="fas fa-check text-xs"></i>
                        </button>
                        <button onclick="submitAction('/delay-item/{{ item.id }}')" class="w-7 h-7 flex items-center justify-center rounded-lg bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors">
                            <i class="fas fa-history text-[10px]"></i>
                        </button>
                        <button onclick="if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) submitAction('/delete-item/{{ item.id }}')" class="w-7 h-7 flex items-center justify-center rounded-lg bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-colors">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Expanded Details (Hidden by default) -->
                <div id="details-{{ item.id }}" class="hidden border-t border-gray-50 bg-gray-50/50 p-4 transition-all animate-in slide-in-from-top duration-200">
                    <form action="/update-item/{{ item.id }}" method="POST" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-wider ml-1">å£å‘³åå¥½</label>
                                <input type="text" name="taste" value="{{ item.taste or '' }}" placeholder="å¾®è¾£/å’¸é²œ"
                                       class="w-full bg-white border-none rounded-xl px-3 py-2.5 text-sm shadow-sm focus:ring-2 focus:ring-orange-500 transition-all outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-wider ml-1">æœŸæœ›æ—¶é—´</label>
                                <input type="text" name="preferred_time" value="{{ item.preferred_time or '' }}" placeholder="12:00 / ä»Šæ™š"
                                       class="w-full bg-white border-none rounded-xl px-3 py-2.5 text-sm shadow-sm focus:ring-2 focus:ring-orange-500 transition-all outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-wider ml-1">äº«ç”¨åœ°ç‚¹</label>
                                <input type="text" name="location" value="{{ item.location or '' }}" placeholder="å®¢å…/é˜³å°"
                                       class="w-full bg-white border-none rounded-xl px-3 py-2.5 text-sm shadow-sm focus:ring-2 focus:ring-orange-500 transition-all outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-wider ml-1">åŸææ–™å¤‡æ³¨</label>
                                <input type="text" name="ingredients" value="{{ item.ingredients or '' }}" placeholder="å°‘ç›/ä¸åƒå§œ"
                                       class="w-full bg-white border-none rounded-xl px-3 py-2.5 text-sm shadow-sm focus:ring-2 focus:ring-orange-500 transition-all outline-none">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-wider ml-1">è¡¥å……å¤‡æ³¨</label>
                            <textarea name="remarks" placeholder="è¿˜æœ‰ä»€ä¹ˆæƒ³è¯´çš„..."
                                      class="w-full bg-white border-none rounded-xl px-3 py-2.5 text-sm shadow-sm focus:ring-2 focus:ring-orange-500 transition-all outline-none h-20 resize-none">{{ item.remarks or '' }}</textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-wider ml-1">å½“å‰çŠ¶æ€</label>
                            <select name="status" class="w-full bg-white border-none rounded-xl px-3 py-2.5 text-sm shadow-sm focus:ring-2 focus:ring-orange-500 transition-all outline-none appearance-none">
                                <option value="pending" {% if item.status == 'pending' %}selected{% endif %}>ğŸ•’ ç­‰å¾…ä¸­</option>
                                <option value="completed" {% if item.status == 'completed' %}selected{% endif %}>âœ… å·²å®Œæˆ</option>
                                <option value="delayed" {% if item.status == 'delayed' %}selected{% endif %}>â³ å·²å»¶æœŸ</option>
                            </select>
                        </div>
                        <div class="flex space-x-3 pt-2">
                            <button type="submit" class="flex-1 bg-gradient-to-r from-orange-400 to-orange-600 text-white font-bold py-3 rounded-2xl shadow-md active:scale-95 transition">ä¿å­˜ä¿®æ”¹</button>
                            <button type="button" onclick="toggleDetails('details-{{ item.id }}')" class="px-6 py-3 bg-gray-200 text-gray-600 font-bold rounded-2xl active:scale-95 transition">æ”¶èµ·</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="flex flex-col items-center justify-center py-20 text-gray-400 space-y-4">
            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center">
                <i class="fas fa-utensils text-4xl text-gray-200"></i>
            </div>
            <p class="font-medium">æš‚æ—¶è¿˜æ²¡æœ‰äººç‚¹èœå“¦</p>
            <a href="/order" class="text-orange-500 font-bold text-sm bg-orange-50 px-6 py-2 rounded-full shadow-sm">ç«‹å³å»ç‚¹é¤</a>
        </div>
    {% endif %}
</div>

<!-- Helper Form for Quick Actions -->
<form id="action-form" method="POST" class="hidden"></form>

<script>
function toggleDetails(id) {
    const el = document.getElementById(id);
    const isHidden = el.classList.contains('hidden');
    
    // Close other open details
    document.querySelectorAll('[id^="details-"]').forEach(item => {
        if (item.id !== id) item.classList.add('hidden');
    });

    if (isHidden) {
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
    }
}

function submitAction(url) {
    const form = document.getElementById('action-form');
    form.action = url;
    form.submit();
}
</script>

<style>
    @keyframes slide-down {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-down {
        animation: slide-down 0.2s ease-out forwards;
    }
</style>
{% endblock %}